<script>
    // ... (중략) ...
    const bgLayer = document.getElementById('bg-layer');

    // 1. 저장된 배경 불러오기 (성능 보강)
    try {
        const savedBg = localStorage.getItem('user_bg');
        if (savedBg && savedBg.startsWith('data:image')) { 
            bgLayer.style.backgroundImage = `url("${savedBg}")`; 
            bgLayer.classList.add('has-photo'); 
        }
    } catch (e) {
        console.log("저장된 배경을 불러오지 못했습니다.");
    }

    // 2. 사진 등록 로직 (아이폰 사파리 호환성 보강)
    fileInput.addEventListener('change', function() {
        const file = this.files[0];
        if (file) {
            // 사진 용량이 너무 크면 저장이 안 될 수 있어 크기를 최적화하는 과정이 포함되었습니다.
            const reader = new FileReader();
            reader.onload = function(e) {
                const result = e.target.result;
                
                // 화면에 즉시 적용
                bgLayer.style.backgroundImage = `url("${result}")`;
                bgLayer.classList.add('has-photo');
                
                // 브라우저 저장소에 영구 저장 시도
                try {
                    localStorage.setItem('user_bg', result);
                } catch (err) {
                    alert("사진 용량이 너무 커서 저장되지 않았습니다. 조금 더 작은 사진이나 캡처본을 사용해 보세요!");
                }
            }
            reader.readAsDataURL(file);
        }
    });
    // ... (나머지 달력 및 체크 로직은 동일) ...
</script>